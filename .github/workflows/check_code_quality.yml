name: Check Code Quality

on: 
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

# ESTA PARTE É CRUCIAL:
# Dá permissão para o GITHUB_TOKEN escrever no repositório
permissions:
  contents: write

jobs:
  check-lint-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    # Use a v4 (a v5 ainda não existe oficialmente)
    # Removemos a linha "token:" pois o permissions acima já resolve
    - uses: actions/checkout@v5
      with:
        submodules: recursive

    - name: Install Node
      uses: actions/setup-node@v5
      with:
        node-version: 20.x

    - name: Cache node modules
      uses: actions/cache@v5
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    # Usa npm install para atualizar o lockfile se necessário
    - name: Install packages
      run: npm install
    
    # Verifica mudanças, commita e faz push
    - name: Commit and Push package-lock.json changes
      run: |
        # Configura o git com o usuário do bot
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # Verifica se houve alteração no package-lock.json
        if [[ `git status --porcelain package-lock.json` ]]; then
          echo "Mudanças detectadas no package-lock.json. Atualizando..."
          git add package-lock.json
          git commit -m "chore(deps): update package-lock.json [skip ci]"
          
          # Tenta fazer o push para a branch atual
          git push
        else
          echo "Nenhuma mudança no package-lock.json."
        fi

    - name: Check linting
      run: npm run lint:check

    - name: Generate Prisma client
      run: npm run db:generate

    - name: Check build
      run: npm run build